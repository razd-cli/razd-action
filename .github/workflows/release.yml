name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð½Ð° Ñ‚ÐµÐ³Ð¸ Ð²Ð¸Ð´Ð° v1.0.0, v2.1.3, etc.

permissions:
  contents: write  # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð²

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ changelog
          
      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Generate changelog
        id: changelog
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ changelog
          cat > changelog.md << 'EOF'
          ## ðŸš€ What's New
          
          EOF
          
          if [ -n "$PREV_TAG" ]; then
            echo "### ðŸ”„ Changes since $PREV_TAG" >> changelog.md
            echo "" >> changelog.md
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚ÐµÐ³Ð°Ð¼Ð¸ Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹
            git log --pretty=format:"%s" $PREV_TAG..HEAD | while read commit; do
              if echo "$commit" | grep -i "^feat\|^add\|^new"; then
                echo "- ðŸš€ **Feature:** $commit" >> changelog.md
              elif echo "$commit" | grep -i "^fix\|^bug"; then
                echo "- ðŸ› **Fix:** $commit" >> changelog.md  
              elif echo "$commit" | grep -i "^doc\|^readme"; then
                echo "- ðŸ“š **Docs:** $commit" >> changelog.md
              elif echo "$commit" | grep -i "^refactor\|^improve"; then
                echo "- ðŸ”§ **Improvement:** $commit" >> changelog.md
              else
                echo "- ðŸ“ $commit" >> changelog.md
              fi
            done
          else
            echo "ðŸŽ‰ **First release of razd-action!**" >> changelog.md
            echo "" >> changelog.md
            echo "### âœ¨ Features:" >> changelog.md
            echo "- âœ… Automatic mise installation (version 2025.11.2)" >> changelog.md  
            echo "- âœ… razd CLI setup via vfox plugin" >> changelog.md
            echo "- âœ… Configurable mise versions" >> changelog.md
            echo "- âœ… Optional repository checkout" >> changelog.md
            echo "- âœ… Installation verification" >> changelog.md
          fi
          
          cat >> changelog.md << EOF
          
          ## ðŸ“– Quick Start
          
          \`\`\`yaml
          - name: Setup razd
            uses: razd-cli/razd-action@${{ steps.tag.outputs.TAG_NAME }}
          \`\`\`
          
          ### ðŸ”§ With custom options:
          \`\`\`yaml  
          - name: Setup razd
            uses: razd-cli/razd-action@${{ steps.tag.outputs.TAG_NAME }}
            with:
              mise-version: '2025.11.2'
              checkout-repository: 'true'
          \`\`\`
          
          ## ðŸ“‹ Parameters
          
          | Parameter | Description | Default |
          |-----------|-------------|---------|
          | \`mise-version\` | Version of mise to install | \`2025.11.2\` |
          | \`checkout-repository\` | Whether to checkout repository | \`true\` |
          
          ## ðŸ“š Documentation
          
          See [README.md](https://github.com/razd-cli/razd-action/blob/main/README.md) for complete documentation.
          
          ---
          **Full Changelog**: https://github.com/razd-cli/razd-action/compare/$PREV_TAG...${{ steps.tag.outputs.TAG_NAME }}
          EOF
          
          # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ changelog Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
          echo "Generated changelog:"
          cat changelog.md
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          name: Release ${{ steps.tag.outputs.TAG_NAME }}
          body_path: changelog.md
          draft: false
          prerelease: false
          generate_release_notes: true  # GitHub Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ ÑÐ¿Ð¸ÑÐ¾Ðº PR Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¸Ð±ÑŒÑŽÑ‚Ð¾Ñ€Ð¾Ð²
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update major version tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_NAME=${{ steps.tag.outputs.TAG_NAME }}
          MAJOR_VERSION=$(echo $TAG_NAME | cut -d. -f1)  # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ v1 Ð¸Ð· v1.2.3
          
          echo "Creating/updating major version tag: $MAJOR_VERSION"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¼Ð°Ð¶Ð¾Ñ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐ³
          git tag -f $MAJOR_VERSION
          git push origin $MAJOR_VERSION --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}